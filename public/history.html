<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Riwayat Skrining - TB Care</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
    <style>
      :root {
        --primary-color: #3498db;
        --bg-light: #f4f7f6;
        --white: #ffffff;
        --shadow-md: 0 8px 30px rgba(0, 0, 0, 0.12);
        --radius: 12px;
      }

      body {
        font-family: "Poppins", sans-serif;
        background-color: var(--bg-light);
        color: #2c3e50;
        margin: 0;
        padding-top: 80px;
      }

      .navbar {
        background: var(--white);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        height: 70px;
        position: fixed;
        top: 0;
        width: 100%;
        z-index: 1000;
        display: flex;
        justify-content: center;
      }
      .nav-container {
        width: 90%;
        max-width: 1000px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .nav-brand {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-color);
        text-decoration: none;
        display: flex;
        gap: 10px;
      }
      .nav-link {
        text-decoration: none;
        color: #2c3e50;
        font-weight: 500;
      }

      .history-wrapper {
        max-width: 800px;
        margin: 40px auto;
        padding: 0 20px;
      }
      .main-card {
        background: var(--white);
        border-radius: var(--radius);
        box-shadow: var(--shadow-md);
        padding: 40px;
        min-height: 400px;
      }

      .header-section {
        text-align: center;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 20px;
        margin-bottom: 30px;
      }
      .header-section h1 {
        color: var(--primary-color);
        margin: 0;
      }

      /* --- CARD ITEM --- */
      .history-item {
        background: #fff;
        border: 1px solid #eee;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        transition: transform 0.2s;
        position: relative;
      }
      .history-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      }

      .item-merah {
        border-left: 6px solid #e74c3c;
        background: #fff5f5;
      }
      .item-kuning {
        border-left: 6px solid #f1c40f;
        background: #fffae6;
      }
      .item-hijau {
        border-left: 6px solid #2ecc71;
        background: #f0fcf6;
      }

      .history-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }
      .history-date {
        font-weight: 500;
        color: #7f8c8d;
      }
      .result-badge {
        padding: 4px 10px;
        border-radius: 4px;
        font-weight: bold;
        font-size: 0.85rem;
      }
      .badge-merah {
        color: #c0392b;
        background: #fadbd8;
      }
      .badge-kuning {
        color: #d35400;
        background: #fdebd0;
      }
      .badge-hijau {
        color: #27ae60;
        background: #d5f5e3;
      }

      /* --- ACTION BUTTONS --- */
      .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        border-top: 1px dashed #ddd;
        padding-top: 15px;
      }
      .btn-action {
        padding: 8px 15px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.85rem;
        transition: 0.2s;
        color: white;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .btn-view {
        background-color: #3498db;
      }
      .btn-view:hover {
        background-color: #2980b9;
      }

      .btn-pdf {
        background-color: #9b59b6;
      }
      .btn-pdf:hover {
        background-color: #8e44ad;
      }

      .btn-delete {
        background-color: #e74c3c;
        margin-left: auto;
      } /* Paling kanan */
      .btn-delete:hover {
        background-color: #c0392b;
      }

      /* --- MODAL UMUM (Styling Dasar) --- */
      .modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(3px);
        animation: fadeIn 0.3s ease;
      }

      /* --- MODAL DETAIL --- */
      .modal-content-detail {
        background: #fff;
        margin: 5% auto;
        padding: 30px;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        position: relative;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.4s ease;
      }
      .close-button {
        float: right;
        font-size: 28px;
        cursor: pointer;
        color: #aaa;
        transition: 0.2s;
      }
      .close-button:hover {
        color: #e74c3c;
      }

      .detail-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 15px;
      }
      .detail-item {
        background: #f8f9fa;
        padding: 8px;
        border-radius: 4px;
        font-size: 0.9rem;
      }

      /* --- MODAL ALERT & CONFIRM (Styling Cantik) --- */
      .confirm-modal-content {
        background-color: var(--white);
        margin: 15% auto;
        padding: 30px;
        border-radius: 16px;
        width: 90%;
        max-width: 380px;
        text-align: center;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s ease;
      }

      .confirm-modal-content h3 {
        color: var(--primary-color);
        font-size: 1.4rem;
        margin-top: 0;
        margin-bottom: 10px;
      }
      .confirm-modal-content p {
        color: #666;
        font-size: 1rem;
        margin-bottom: 25px;
      }

      .confirm-buttons {
        display: flex;
        justify-content: center;
        gap: 15px;
      }
      .confirm-buttons button {
        padding: 10px 25px;
        border: none;
        border-radius: 50px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
      }
      .confirm-buttons button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }

      /* --- ANIMATIONS --- */
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* --- EMPTY STATE --- */
      .empty-state {
        text-align: center;
        padding: 40px;
        color: #7f8c8d;
        display: none;
      }
      .empty-btn {
        display: inline-block;
        margin-top: 15px;
        padding: 10px 20px;
        background: var(--primary-color);
        color: white;
        text-decoration: none;
        border-radius: 20px;
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <nav class="navbar">
      <div class="nav-container">
        <a href="index.html" class="nav-brand">TB Care</a>
        <a href="index.html" class="nav-link">&larr; Kembali</a>
      </div>
    </nav>

    <div class="history-wrapper">
      <div class="main-card">
        <div class="header-section">
          <h1>Riwayat Skrining Saya</h1>
          <div style="margin-top: 5px; font-weight: 600" id="userNameDisplay">
            ...
          </div>
        </div>

        <div id="loadingStatus" style="text-align: center">
          Sedang memuat...
        </div>

        <ul id="historyList" class="history-list"></ul>

        <div id="emptyState" class="empty-state">
          <h3>Belum Ada Riwayat</h3>
          <p>Anda belum pernah melakukan skrining.</p>
          <a href="index.html" class="empty-btn">Mulai Skrining</a>
        </div>
      </div>
    </div>

    <div id="detailModal" class="modal">
      <div class="modal-content-detail">
        <span class="close-button" onclick="closeDetailModal()">&times;</span>
        <h2
          style="
            color: #3498db;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
          "
        >
          Detail Skrining
        </h2>
        <div id="detailContent"></div>
      </div>
    </div>

    <div id="deleteConfirmModal" class="modal">
      <div class="confirm-modal-content">
        <h3 style="color: #e74c3c">Hapus Riwayat?</h3>
        <p>
          Data ini akan dihapus secara permanen dan tidak dapat dikembalikan.
        </p>
        <div class="confirm-buttons">
          <button
            id="btnConfirmDelete"
            style="background-color: #e74c3c; color: white"
          >
            Ya, Hapus
          </button>
          <button
            onclick="closeDeleteModal()"
            style="background-color: #bdc3c7; color: #333"
          >
            Batal
          </button>
        </div>
      </div>
    </div>

    <div id="messageAlertModal" class="modal">
      <div class="confirm-modal-content">
        <h3 id="alertTitle">Info</h3>
        <p id="alertMessage">Pesan...</p>
        <div class="confirm-buttons">
          <button
            onclick="closeAlertModal()"
            style="background-color: #3498db; color: white"
          >
            OK
          </button>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.14/jspdf.plugin.autotable.min.js"></script>

    <script>
      const USER_ID_KEY = "currentUserId";
      const USER_NAME_KEY = "currentUserName";
      let globalHistoryData = [];
      let deleteTargetId = null; // Menyimpan ID yang akan dihapus

      document.addEventListener("DOMContentLoaded", () => {
        const userId = localStorage.getItem(USER_ID_KEY);
        if (!userId) {
          customAlert("Harap login terlebih dahulu.", "Akses Ditolak");
          setTimeout(() => {
            window.location.href = "index.html";
          }, 1500);
          return;
        }
        document.getElementById("userNameDisplay").textContent =
          localStorage.getItem(USER_NAME_KEY);
        loadHistory(userId);
      });

      // --- UTILITY: CUSTOM ALERTS & MODALS ---
      function customAlert(message, title = "Informasi") {
        document.getElementById("alertTitle").textContent = title;
        document.getElementById("alertMessage").textContent = message;
        document.getElementById("messageAlertModal").style.display = "block";
      }

      function closeAlertModal() {
        document.getElementById("messageAlertModal").style.display = "none";
      }

      function showDeleteModal(id) {
        deleteTargetId = id;
        document.getElementById("deleteConfirmModal").style.display = "block";
      }

      function closeDeleteModal() {
        deleteTargetId = null;
        document.getElementById("deleteConfirmModal").style.display = "none";
      }

      // Listener Tombol Konfirmasi Hapus
      document
        .getElementById("btnConfirmDelete")
        .addEventListener("click", () => {
          if (deleteTargetId) {
            deleteHistory(deleteTargetId);
            closeDeleteModal();
          }
        });

      // --- LOGIC UTAMA ---

      async function loadHistory(userId) {
        try {
          const response = await fetch(`/api/history/${userId}`);
          const result = await response.json();
          document.getElementById("loadingStatus").style.display = "none";

          if (result.status === "sukses" && result.data.length > 0) {
            globalHistoryData = result.data;
            renderList(result.data);
          } else {
            document.getElementById("emptyState").style.display = "block";
          }
        } catch (error) {
          customAlert("Gagal memuat riwayat dari server.", "Error Koneksi");
          console.error(error);
        }
      }

      function renderList(data) {
        const list = document.getElementById("historyList");
        list.innerHTML = "";

        data.forEach((item, index) => {
          const date = new Date(item.tanggalSkrining).toLocaleDateString(
            "id-ID",
            { dateStyle: "full" }
          );
          const pitaColor = item.pitaLila.toLowerCase();

          const li = document.createElement("li");
          li.className = `history-item item-${pitaColor}`;
          li.innerHTML = `
                    <div class="history-header">
                        <span class="history-date">${date}</span>
                        <span class="result-badge badge-${pitaColor}">${item.pitaLila} (Skor: ${item.totalScore})</span>
                    </div>
                    <p style="font-size: 0.9em; color: #555;">${item.rekomendasi}</p>
                    
                    <div class="action-buttons">
                        <button class="btn-action btn-view" onclick="viewDetail(${index})">üëÅÔ∏è Lihat Detail</button>
                        <button class="btn-action btn-pdf" onclick="exportPdf(${index})">üìÑ PDF</button>
                        <button class="btn-action btn-delete" onclick="showDeleteModal('${item._id}')">üóëÔ∏è Hapus</button>
                    </div>
                `;
          list.appendChild(li);
        });
      }

      // --- FITUR 1: LIHAT DETAIL ---
      window.viewDetail = function (index) {
        const item = globalHistoryData[index];
        const content = document.getElementById("detailContent");

        let html = `<p><strong>Nama:</strong> ${item.nama}</p>
                        <p><strong>Usia:</strong> ${item.usia || "-"} Tahun</p>
                        <p><strong>PITA LILA:</strong> ${item.pitaLila}</p>
                        <p><strong>Rekomendasi:</strong> ${item.rekomendasi}</p>
                        <hr><h4>Jawaban:</h4><div class="detail-grid">`;

        if (item.dataSkrining) {
          Object.entries(item.dataSkrining).forEach(([k, v]) => {
            if (v === "Ya" || v === "Tidak") {
              let key = k
                .replace(/([A-Z])/g, " $1")
                .trim()
                .replace(/([a-z])([A-Z])/g, "$1 $2"); // Format camelCase
              html += `<div class="detail-item"><strong>${key}:</strong> ${v}</div>`;
            }
          });
        }
        html += `</div>`;
        content.innerHTML = html;
        document.getElementById("detailModal").style.display = "block";
      };

      window.closeDetailModal = function () {
        document.getElementById("detailModal").style.display = "none";
      };

      window.onclick = function (e) {
        if (e.target == document.getElementById("detailModal"))
          closeDetailModal();
        if (e.target == document.getElementById("deleteConfirmModal"))
          closeDeleteModal();
        if (e.target == document.getElementById("messageAlertModal"))
          closeAlertModal();
      };

      // --- FITUR 2: EKSPOR PDF ---
      window.exportPdf = function (index) {
        const item = globalHistoryData[index];
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.setFontSize(16);
        doc.text("Hasil Skrining TB", 14, 20);
        doc.setFontSize(10);
        doc.text(
          `Tanggal: ${new Date(item.tanggalSkrining).toLocaleDateString()}`,
          14,
          30
        );
        doc.text(`Nama: ${item.nama}`, 14, 35);
        doc.text(`Hasil: ${item.pitaLila} (Skor: ${item.totalScore})`, 14, 40);

        const splitRec = doc.splitTextToSize(
          `Rekomendasi: ${item.rekomendasi}`,
          180
        );
        doc.text(splitRec, 14, 50);

        const rows = [];
        Object.entries(item.dataSkrining).forEach(([k, v]) => {
          if (v === "Ya" || v === "Tidak")
            rows.push([k.replace(/([A-Z])/g, " $1"), v]);
        });

        doc.autoTable({
          startY: 65,
          head: [["Pertanyaan", "Jawaban"]],
          body: rows,
        });
        doc.save(`skrining_${item.nama}.pdf`);
      };

      // --- FITUR 3: HAPUS ---
      async function deleteHistory(id) {
        try {
          const response = await fetch(`/api/skrining/${id}`, {
            method: "DELETE",
          });
          const result = await response.json();
          if (result.status === "sukses") {
            customAlert("Data berhasil dihapus.", "Sukses");
            loadHistory(localStorage.getItem(USER_ID_KEY)); // Reload
          } else {
            customAlert("Gagal menghapus: " + result.message, "Gagal");
          }
        } catch (e) {
          customAlert("Terjadi kesalahan server.", "Error");
        }
      }
    </script>
  </body>
</html>
