<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Admin - TB Care</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
    <style>
      :root {
        --primary: #3498db;
        --primary-dark: #2980b9;
        --secondary: #2c3e50;
        --success: #2ecc71;
        --warning: #f1c40f;
        --danger: #e74c3c;
        --light: #f8f9fa;
        --white: #ffffff;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        --radius: 12px;
      }

      body {
        font-family: "Poppins", sans-serif;
        background-color: #f0f2f5;
        margin: 0;
        padding: 0;
        color: var(--secondary);
      }

      .admin-container {
        max-width: 1250px;
        margin: 40px auto;
        padding: 40px;
        background: var(--white);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
      }

      /* --- HEADER --- */
      .header-admin {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid #eee;
        padding-bottom: 20px;
        margin-bottom: 30px;
      }

      .header-admin h1 {
        font-size: 1.8rem;
        color: var(--secondary);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .logout-btn {
        background-color: #fff0f0;
        color: var(--danger);
        border: 1px solid var(--danger);
        padding: 10px 24px;
        border-radius: 50px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      .logout-btn:hover {
        background-color: var(--danger);
        color: var(--white);
      }

      /* --- CONTROLS --- */
      .controls-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        background-color: #f8fbff;
        padding: 15px 20px;
        border-radius: var(--radius);
        border: 1px solid #eef2f7;
      }

      .data-count {
        font-weight: 500;
        color: #666;
      }

      .data-count span {
        color: var(--primary);
        font-weight: 700;
        font-size: 1.2rem;
      }

      .export-group {
        display: flex;
        gap: 10px;
      }

      .btn-export {
        padding: 10px 18px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        color: white;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: transform 0.2s;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .btn-excel {
        background-color: #21a366;
      }
      .btn-pdf {
        background-color: #d32f2f;
      }
      .btn-export:hover {
        transform: translateY(-2px);
        opacity: 0.9;
      }

      /* --- TABLE STYLING (DIPERBAIKI) --- */
      .table-responsive {
        overflow-x: auto;
        border-radius: var(--radius);
        box-shadow: 0 0 0 1px #eee;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
      }

      /* Header Table */
      thead {
        background-color: var(--primary);
        color: white;
      }

      th {
        padding: 18px 15px;
        text-align: left;
        font-weight: 600;
        letter-spacing: 0.5px;
        white-space: nowrap;
        /* Pastikan background header tidak tertimpa */
        background-color: var(--primary);
        color: white;
      }

      td {
        padding: 15px;
        border-bottom: 1px solid #f0f0f0;
        color: #444;
        vertical-align: middle;
      }

      /* FIX: Hover hanya berlaku untuk baris di dalam TBODY */
      tbody tr:hover {
        background-color: #f8faff;
      }

      /* --- BADGES --- */
      .badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 700;
        font-size: 0.75rem;
        text-transform: uppercase;
        display: inline-block;
        min-width: 80px;
        text-align: center;
      }
      .badge-merah {
        background-color: #fde2e2;
        color: #c0392b;
      }
      .badge-kuning {
        background-color: #fff4cc;
        color: #d68910;
      }
      .badge-hijau {
        background-color: #dbf2e3;
        color: #219150;
      }

      .btn-detail {
        background-color: white;
        color: var(--primary);
        border: 1px solid var(--primary);
        padding: 6px 15px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 600;
        transition: all 0.2s;
      }
      .btn-detail:hover {
        background-color: var(--primary);
        color: white;
      }

      /* --- MODALS --- */
      .modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        animation: fadeIn 0.3s ease;
      }

      .modal-content-detail {
        background-color: #fff;
        margin: 3% auto;
        padding: 0;
        border-radius: 16px;
        width: 90%;
        max-width: 750px;
        position: relative;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
        animation: slideUp 0.4s ease;
        overflow: hidden;
      }

      .detail-header {
        background-color: var(--primary);
        color: white;
        padding: 20px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .detail-header h2 {
        margin: 0;
        font-size: 1.4rem;
        color: white;
      }

      .close-button {
        color: white;
        font-size: 28px;
        cursor: pointer;
        opacity: 0.8;
        transition: opacity 0.2s;
      }
      .close-button:hover {
        opacity: 1;
      }

      .detail-body {
        padding: 30px;
        overflow-y: auto;
      }

      .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 12px;
      }
      .info-item label {
        display: block;
        font-size: 0.85rem;
        color: #7f8c8d;
        margin-bottom: 4px;
      }
      .info-item span {
        font-weight: 600;
        color: #2c3e50;
        font-size: 1rem;
      }

      .result-section {
        margin-bottom: 25px;
        padding: 15px;
        border-radius: 8px;
        border-left: 5px solid #ccc;
      }
      .answers-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }
      .answer-card {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        background: white;
        border: 1px solid #eee;
        border-radius: 8px;
      }
      .ans-yes {
        color: var(--danger);
        font-weight: bold;
      }
      .ans-no {
        color: var(--success);
        font-weight: bold;
      }

      .detail-footer {
        padding: 20px 30px;
        border-top: 1px solid #eee;
        text-align: right;
        background-color: #fcfcfc;
      }

      /* Confirm Modal */
      .confirm-modal-content {
        background: white;
        margin: 15% auto;
        padding: 30px;
        border-radius: 16px;
        width: 90%;
        max-width: 350px;
        text-align: center;
        box-shadow: var(--shadow);
        animation: slideUp 0.3s ease;
      }
      .confirm-buttons {
        margin-top: 25px;
        display: flex;
        justify-content: center;
        gap: 15px;
      }
      .btn-confirm {
        padding: 10px 25px;
        border-radius: 50px;
        border: none;
        font-weight: 600;
        cursor: pointer;
      }
      .btn-yes {
        background: var(--danger);
        color: white;
      }
      .btn-no {
        background: #eee;
        color: #333;
      }
      .btn-ok {
        background: var(--primary);
        color: white;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @media (max-width: 768px) {
        .answers-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="admin-container">
      <div class="header-admin">
        <h1>
          üõ°Ô∏è Admin Panel
          <span
            style="
              font-weight: 300;
              font-size: 0.8em;
              margin-left: 10px;
              color: #7f8c8d;
            "
            >TB Care</span
          >
        </h1>
        <button id="logoutButton" class="logout-btn">Logout</button>
      </div>

      <div class="controls-bar">
        <div class="data-count">
          Total Laporan: <span id="totalDataCount">0</span>
        </div>
        <div class="export-group">
          <button id="exportExcelButton" class="btn-export btn-excel">
            üìä Excel
          </button>
          <button id="exportPdfButton" class="btn-export btn-pdf">
            üìÑ PDF
          </button>
        </div>
      </div>

      <div class="table-responsive">
        <table>
          <thead>
            <tr>
              <th>Tanggal</th>
              <th>Nama</th>
              <th>Akun</th>
              <th>Usia</th>
              <th style="text-align: center">Status</th>
              <th>Skor</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="dataTableBody"></tbody>
        </table>
      </div>
      <p
        id="loadingStatus"
        style="text-align: center; margin-top: 30px; color: #777"
      >
        Sedang memuat data...
      </p>
    </div>

    <div id="detailModal" class="modal">
      <div class="modal-content-detail">
        <div class="detail-header">
          <h2>Detail Hasil Skrining</h2>
          <span class="close-button" onclick="closeDetailModal()">&times;</span>
        </div>
        <div id="detailContent" class="detail-body"></div>
        <div class="detail-footer">
          <button
            id="exportDetailPdfButton"
            class="btn-export btn-pdf"
            style="display: inline-flex"
          >
            üñ®Ô∏è Cetak Laporan PDF
          </button>
        </div>
      </div>
    </div>

    <div id="logoutConfirmModal" class="modal">
      <div class="confirm-modal-content">
        <h3 style="color: var(--danger)">Keluar Dashboard?</h3>
        <p style="color: #666">Anda yakin ingin mengakhiri sesi admin?</p>
        <div class="confirm-buttons">
          <button id="confirmYes" class="btn-confirm btn-yes">
            Ya, Keluar
          </button>
          <button id="confirmNo" class="btn-confirm btn-no">Batal</button>
        </div>
      </div>
    </div>

    <div id="messageAlertModal" class="modal">
      <div class="confirm-modal-content">
        <h3 id="alertTitle" style="color: var(--primary)">Info</h3>
        <p id="alertMessage" style="color: #666">Pesan...</p>
        <div class="confirm-buttons">
          <button onclick="closeAlertModal()" class="btn-confirm btn-ok">
            OK
          </button>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.14/jspdf.plugin.autotable.min.js"></script>

    <script>
      const ADMIN_KEY_STORAGE = "adminAccessKey";
      const ACCESS_KEY = localStorage.getItem(ADMIN_KEY_STORAGE);
      const DASHBOARD_ENDPOINT = "/admin/data/json?password=";

      let globalSkriningData = [];
      let currentDetailItem = null;

      if (!ACCESS_KEY) window.location.href = "index.html";

      function customAlert(message, title = "Informasi") {
        document.getElementById("alertTitle").textContent = title;
        document.getElementById("alertMessage").textContent = message;
        document.getElementById("messageAlertModal").style.display = "block";
      }
      function closeAlertModal() {
        document.getElementById("messageAlertModal").style.display = "none";
      }

      async function loadAdminData() {
        const status = document.getElementById("loadingStatus");
        try {
          const response = await fetch(`${DASHBOARD_ENDPOINT}${ACCESS_KEY}`);
          if (response.status === 401) throw new Error("Akses Ditolak");
          const data = await response.json();
          const results = data.results || [];
          globalSkriningData = results;
          document.getElementById("totalDataCount").textContent =
            results.length;
          renderTable(results);
          status.style.display = "none";
        } catch (error) {
          status.innerHTML = `<span style="color:red">Gagal memuat data. ${error.message}</span>`;
          if (error.message.includes("Akses Ditolak")) {
            localStorage.removeItem(ADMIN_KEY_STORAGE);
            setTimeout(() => (window.location.href = "index.html"), 1500);
          }
        }
      }

      function renderTable(results) {
        const tbody = document.getElementById("dataTableBody");
        tbody.innerHTML = "";
        if (results.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">Belum ada data skrining.</td></tr>';
          return;
        }
        results.forEach((item, index) => {
          const pitaLila = item.pitaLila || "-";
          const badgeClass = `badge-${pitaLila.toLowerCase()}`;
          const dateStr = new Date(item.tanggalSkrining).toLocaleDateString(
            "id-ID",
            { day: "numeric", month: "short", year: "numeric" }
          );
          const userDisplay = item.userId
            ? item.userId.username
            : '<span style="color:#999; font-style:italic;">Guest</span>';
          const row = tbody.insertRow();
          row.innerHTML = `
                    <td>${dateStr}</td>
                    <td style="font-weight:500; color:#2c3e50;">${
                      item.nama
                    }</td>
                    <td>${userDisplay}</td>
                    <td>${item.usia || "-"}</td>
                    <td style="text-align:center;"><span class="badge ${badgeClass}">${pitaLila}</span></td>
                    <td><strong>${item.totalScore}</strong></td>
                    <td><button onclick='openDetail(${index})' class="btn-detail">üëÅÔ∏è Detail</button></td>
                `;
        });
      }

      window.openDetail = function (index) {
        const item = globalSkriningData[index];
        currentDetailItem = item;
        const content = document.getElementById("detailContent");
        let borderColor = "#2ecc71";
        if (item.pitaLila === "Kuning") borderColor = "#f1c40f";
        if (item.pitaLila === "Merah") borderColor = "#e74c3c";

        let html = `
                <div class="info-grid">
                    <div class="info-item"><label>Nama Lengkap</label><span>${
                      item.nama
                    }</span></div>
                    <div class="info-item"><label>Username</label><span>${
                      item.userId ? item.userId.username : "Guest"
                    }</span></div>
                    <div class="info-item"><label>Usia</label><span>${
                      item.usia || "-"
                    } Tahun</span></div>
                    <div class="info-item"><label>No. Telepon</label><span>${
                      item.no_telp || "-"
                    }</span></div>
                    <div class="info-item"><label>Tanggal</label><span>${new Date(
                      item.tanggalSkrining
                    ).toLocaleDateString("id-ID", {
                      dateStyle: "full",
                    })}</span></div>
                    <div class="info-item"><label>Audio Batuk</label><span>${
                      item.audioFilePath
                        ? `<a href="/${item.audioFilePath}" target="_blank" style="color:#3498db;">üéß Putar</a>`
                        : "-"
                    }</span></div>
                </div>
                <div class="result-section" style="border-left-color: ${borderColor}; background-color: ${borderColor}10;">
                    <h3 style="margin-top:0; color:${borderColor};">Hasil: ${
          item.pitaLila
        } (Skor: ${item.totalScore})</h3>
                    <p style="margin-bottom:0; color:#444;"><strong>Rekomendasi:</strong> ${
                      item.rekomendasi
                    }</p>
                </div>
                <div class="answers-container">
                    <h3>Rincian Jawaban</h3>
                    <div class="answers-grid">`;
        if (item.dataSkrining) {
          Object.entries(item.dataSkrining).forEach(([k, v]) => {
            if (v === "Ya" || v === "Tidak") {
              const label = k
                .replace(/([A-Z])/g, " $1")
                .trim()
                .replace(/([a-z])([A-Z])/g, "$1 $2");
              const valClass = v === "Ya" ? "ans-yes" : "ans-no";
              html += `<div class="answer-card"><span class="ans-label">${label}</span><span class="ans-val ${valClass}">${v}</span></div>`;
            }
          });
        }
        html += `</div></div>`;
        content.innerHTML = html;
        document.getElementById("detailModal").style.display = "block";
      };

      window.closeDetailModal = () =>
        (document.getElementById("detailModal").style.display = "none");

      function formatDataForExport(data) {
        return data.map((item) => ({
          Tanggal: new Date(item.tanggalSkrining).toLocaleDateString("id-ID"),
          Nama: item.nama,
          Username: item.userId ? item.userId.username : "Guest",
          Usia: item.usia || "-",
          "No. HP": item.no_telp,
          Kategori: item.pitaLila,
          Skor: item.totalScore,
          Rekomendasi: item.rekomendasi,
        }));
      }

      document
        .getElementById("exportExcelButton")
        .addEventListener("click", () => {
          if (globalSkriningData.length === 0)
            return customAlert("Data kosong.", "Info");
          const ws = XLSX.utils.json_to_sheet(
            formatDataForExport(globalSkriningData)
          );
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "Data Skrining");
          XLSX.writeFile(wb, "Rekap_Skrining_TB.xlsx");
        });

      document
        .getElementById("exportPdfButton")
        .addEventListener("click", () => {
          if (globalSkriningData.length === 0)
            return customAlert("Data kosong.", "Info");
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF("landscape");
          doc.text("Rekap Data Skrining TB Care", 14, 15);
          doc.setFontSize(10);
          doc.text(`Dicetak: ${new Date().toLocaleDateString()}`, 14, 22);
          const data = formatDataForExport(globalSkriningData);
          const body = data.map((obj) => Object.values(obj));
          const headers = [Object.keys(data[0])];
          doc.autoTable({
            head: headers,
            body: body,
            startY: 30,
            styles: { fontSize: 8 },
            headStyles: { fillColor: [44, 62, 80] },
          });
          doc.save("Rekap_Semua_Data.pdf");
        });

      document
        .getElementById("exportDetailPdfButton")
        .addEventListener("click", () => {
          if (!currentDetailItem) return;
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          const item = currentDetailItem;
          doc.setFillColor(52, 152, 219);
          doc.rect(0, 0, 210, 35, "F");
          doc.setTextColor(255);
          doc.setFontSize(20);
          doc.text("Laporan Hasil Skrining", 105, 20, null, null, "center");
          doc.setTextColor(0);
          doc.setFontSize(11);
          doc.text(`Nama: ${item.nama}`, 14, 50);
          doc.text(
            `Tanggal: ${new Date(item.tanggalSkrining).toLocaleDateString()}`,
            140,
            50
          );

          const resColor =
            item.pitaLila === "Merah"
              ? [231, 76, 60]
              : item.pitaLila === "Kuning"
              ? [243, 156, 18]
              : [46, 204, 113];
          doc.setTextColor(resColor[0], resColor[1], resColor[2]);
          doc.setFontSize(14);
          doc.text(
            `Hasil: ${item.pitaLila} (Skor: ${item.totalScore})`,
            14,
            65
          );

          doc.setTextColor(50);
          doc.setFontSize(10);
          const rec = doc.splitTextToSize(
            `Rekomendasi: ${item.rekomendasi}`,
            180
          );
          doc.text(rec, 14, 72);

          const rows = [];
          if (item.dataSkrining) {
            Object.entries(item.dataSkrining).forEach(([k, v]) => {
              if (v === "Ya" || v === "Tidak")
                rows.push([k.replace(/([A-Z])/g, " $1").trim(), v]);
            });
          }
          doc.autoTable({
            startY: 85 + rec.length * 5,
            head: [["Pertanyaan", "Jawaban"]],
            body: rows,
            theme: "striped",
          });
          doc.save(`Laporan_${item.nama}.pdf`);
        });

      document.getElementById("logoutButton").onclick = () =>
        (document.getElementById("logoutConfirmModal").style.display = "block");
      document.getElementById("confirmNo").onclick = () =>
        (document.getElementById("logoutConfirmModal").style.display = "none");
      document.getElementById("confirmYes").onclick = () => {
        localStorage.removeItem(ADMIN_KEY_STORAGE);
        window.location.href = "index.html";
      };
      window.onclick = (e) => {
        if (e.target.classList.contains("modal"))
          e.target.style.display = "none";
      };

      loadAdminData();
    </script>
  </body>
</html>
